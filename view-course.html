<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Exam Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root { --body-bg: #F9FAFB; --widget-bg: #FFFFFF; --border-color: #E5E7EB; --text-primary: #002726; --text-secondary: #6B7280; --brand-green: #33C375; --hover-bg: #F3F4F6; --warning-color: #F59E0B; --danger-color: #EF4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; overflow-y: auto; }
        
        /* Layout Adjustment: Full Width */
        .dashboard-container { display: flex; flex-direction: column; min-height: 100vh; position: relative; }
        
        .main-area { display: flex; flex-direction: column; flex-grow: 1; background-color: var(--body-bg); }
        
        /* Header Styles */
        .main-header { padding: 1.25rem 3rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--widget-bg); position: sticky; top: 0; z-index: 50; }
        .main-header h1 { font-size: 1.5rem; font-weight: 600; }
        
        /* Profile in Header Styles */
        .header-right { position: relative; display: flex; align-items: center; gap: 1rem; }
        .profile-section { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s; }
        .profile-section:hover { background-color: var(--hover-bg); }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border-color); }
        .profile-details { display: flex; flex-direction: column; align-items: flex-end; }
        .profile-name { font-weight: 600; white-space: nowrap; }
        .profile-email { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; }
        
        /* Profile Dropdown */
        .profile-popup { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background-color: var(--widget-bg); border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1); border: 1px solid var(--border-color); padding: 0.75rem; z-index: 100; opacity: 0; pointer-events: none; transform: translateY(10px) scale(0.95); transition: opacity 0.2s ease, transform 0.2s ease; width: 200px; }
        .profile-popup.active { opacity: 1; pointer-events: all; transform: translateY(0) scale(1); }
        .popup-list { list-style: none; }
        .popup-list a { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem; border-radius: 6px; text-decoration: none; color: var(--text-primary); }
        .popup-list a:hover { background-color: var(--hover-bg); }
        .popup-list a i { font-size: 1.2rem; color: var(--text-secondary); }
        .popup-list a.logout { color: var(--danger-color); }
        .popup-list a.logout i { color: var(--danger-color); }

        /* Content Body */
        .content-body { padding: 2rem 3rem; display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: flex-start; }
        .column { display: flex; flex-direction: column; gap: 2rem; }
        
        /* Widgets */
        .widget { background-color: var(--widget-bg); border-radius: 16px; border: 1px solid var(--border-color); padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03), 0 2px 4px -1px rgba(0,0,0,0.02); }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .widget-header h2 { font-size: 1.125rem; font-weight: 600; }
        .widget-header a { font-size: 0.9rem; color: var(--brand-green); text-decoration: none; font-weight: 500; cursor: pointer; }
        
        /* Specific Widgets */
        .featured-course { background-color: var(--text-primary); color: #FFFFFF; border: none; }
        .featured-course h4 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem; }
        .featured-course h3 { font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-bottom: 0.75rem; }
        .progress { height: 100%; background: var(--brand-green); border-radius: 10px; width: 0; transition: width 0.5s ease; }
        .progress-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .btn-continue { background: var(--brand-green); color: #FFFFFF; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s ease; text-decoration: none; }
        
        .enrollment-prompt-widget { background-color: #002726; color: white; }
        .enrollment-prompt { text-align: center; padding: 2rem; }
        .enrollment-prompt h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .enrollment-prompt p { color: rgba(255, 255, 255, 0.7); margin-bottom: 1.5rem; }
        
        .course-outline-list { list-style: none; position: relative; padding-left: 1.5rem; }
        .course-outline-list::before { content: ''; position: absolute; left: 10px; top: 10px; bottom: 10px; width: 2px; background-color: var(--border-color); }
        .outline-item { position: relative; margin-bottom: 1.5rem; display: flex; } .outline-item:last-child { margin-bottom: 0; }
        .outline-marker { position: absolute; left: -24px; top: 0; width: 20px; height: 20px; border-radius: 50%; background-color: var(--widget-bg); border: 2px solid var(--border-color); display: grid; place-items: center; font-size: 0.8rem; }
        .outline-item.completed .outline-marker { border-color: var(--brand-green); background-color: var(--brand-green); color: white; }
        .outline-item.current .outline-marker { border-color: var(--danger-color); background-color: var(--widget-bg); color: var(--danger-color); width: 24px; height: 24px; left: -26px; top: -2px; }
        .outline-item.current .outline-marker::before { content: ''; width: 12px; height: 12px; background-color: var(--danger-color); border-radius: 50%; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .outline-info h4 { font-weight: 600; } .outline-info p { color: var(--text-secondary); font-size: 0.9rem; }
        .outline-item.completed h4 { text-decoration: line-through; color: var(--text-secondary); }
        
        .progress-chart-container { display: flex; align-items: center; gap: 2rem; }
        .circular-progress-container { position: relative; width: 120px; height: 120px; }
        .progress-ring__svg { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.8s ease-out; }
        .progress-center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .progress-center-text strong { display: block; font-size: 2rem; font-weight: 700; color: var(--brand-green); }
        .progress-center-text span { font-size: 0.8rem; color: var(--text-secondary); }
        .progress-stats { display: flex; flex-direction: column; gap: 1rem; }
        .stat p { font-size: 0.9rem; color: var(--text-secondary); } .stat strong { font-size: 1.25rem; font-weight: 600; }
        
        .notification-list { list-style: none; display: flex; flex-direction: column; }
        .notification-item { display: flex; align-items: center; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .notification-item:last-child { border-bottom: none; }
        .notification-content { display: flex; align-items: flex-start; gap: 1rem; flex-grow: 1; }
        .notification-icon { flex-shrink: 0; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; font-size: 1.2rem; }
        .notification-icon.general { background-color: #E0E7FF; color: #4F46E5; }
        .notification-icon.warning { background-color: #FEF3C7; color: var(--warning-color); }
        .notification-icon.danger { background-color: #FEE2E2; color: var(--danger-color); }
        .notification-info h4 { font-weight: 600; margin-bottom: 0.25rem; }
        .notification-info p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }
        .btn-notification { background: var(--hover-bg); color: var(--text-primary); text-decoration: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; font-size: 0.85rem; white-space: nowrap; margin-left: auto; align-self: center; }
        
        .tab-container { display: flex; position: relative; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { padding: 0.8rem 1rem; border: none; background: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: color 0.3s ease; }
        .tab-btn.active { color: var(--text-primary); }
        .active-line { position: absolute; bottom: 0; height: 2px; background-color: var(--brand-green); border-radius: 2px; transition: left 0.3s ease-in-out, width 0.3s ease-in-out; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        .profile-list { list-style: none; display: flex; flex-direction: column; gap: 1rem; }
        .profile-item { display: flex; align-items: center; }
        .profile-item .rank { font-size: 1rem; font-weight: 600; color: var(--text-secondary); width: 30px; }
        .profile-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem; object-fit: cover; }
        .profile-info { flex-grow: 1; min-width: 0; }
        .profile-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .profile-affiliation { color: var(--text-secondary); font-size: 0.85rem; }
        .profile-item .score { font-weight: 600; color: var(--brand-green); display: flex; align-items: center; gap: 0.5rem; }
        .profile-item .score .crown { color: var(--warning-color); font-size: 1.2rem; }
        .profile-list .user-separator { margin: 0.5rem 0; border: 0; height: 1px; background: var(--border-color); }
        
        .placeholder-text { color: var(--text-secondary); text-align: center; padding: 2rem; }

        @media (max-width: 1024px) {
            .content-body { grid-template-columns: 1fr; padding: 1.5rem; }
            .main-header { padding: 1.25rem 1.5rem; }
            .profile-details { display: none; } /* Hide name on mobile to save space */
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Removed -->
        
        <main class="main-area">
            <header class="main-header">
                <div class="logo-area">
                    <!-- Optional: You can put the logo here if you want -->
                    <img src="" alt="Ihtnas Logo" class="logo-image" style="height: 32px;">
                    <h1>Dashboard</h1>
                </div>

                <!-- Moved Profile Section to Header -->
                <div class="header-right">
                    <div class="profile-section" id="profile-section">
                        <div class="profile-details">
                            <span class="profile-name"></span>
                            <span class="profile-email"></span>
                        </div>
                        <img src="" alt="Profile Picture" class="profile-avatar">
                        <i class='bx bx-chevron-down'></i>
                    </div>
                    
                    <div class="profile-popup" id="profile-popup">
                        <ul class="popup-list">
                            <li><a href="profile.html"><i class='bx bx-user'></i> Profile</a></li>
                            <li><a href="#" class="logout" id="logout-btn"><i class='bx bx-log-out'></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Skeleton Loader Removed - Showing content immediately (initially empty until JS fills it) -->
            <section class="content-body" id="real-content">
                <div class="column main-col">
                    <div class="widget featured-course" id="featured-course-widget" style="display: none;">
                        <h4>CONTINUE LEARNING</h4>
                        <h3 id="featured-course-title"></h3>
                        <div class="progress-bar"><div class="progress" id="featured-course-progress"></div></div>
                        <div class="progress-info"><span id="featured-course-subject"></span><span id="featured-course-percent"></span></div>
                        <a href="#" class="btn-continue" id="featured-course-link">Continue Learning</a>
                    </div>
                    <div class="widget enrollment-prompt-widget" id="enrollment-prompt" style="display: none;">
                        <div class="enrollment-prompt">
                            <h3>Welcome to the Portal!</h3>
                            <p>You are not yet enrolled in any courses. Enroll now to start your learning journey.</p>
                            <a href="course-enroll.html" class="btn-continue">Enroll in a Course</a>
                        </div>
                    </div>
                    <div class="widget" id="course-outline-widget" style="display: none;">
                        <div class="widget-header">
                            <h2>Course Outline</h2>
                            <a href="#" id="toggle-chapters-btn" style="display: none;">Show All</a>
                        </div>
                        <ol class="course-outline-list" id="course-outline-list"></ol>
                    </div>
                </div>
                <div class="column side-col">
                    <div class="widget">
                        <div class="widget-header"><h2>Progress</h2></div>
                        <div class="progress-chart-container">
                            <div class="circular-progress-container">
                                <svg class="progress-ring__svg" width="120" height="120">
                                    <circle stroke="#E5E7EB" stroke-width="10" fill="transparent" r="52" cx="60" cy="60"/>
                                    <circle class="progress-ring__circle" id="overall-progress-ring" stroke="var(--brand-green)" stroke-linecap="round" stroke-width="10" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
                                </svg>
                                <div class="progress-center-text"><strong id="overall-progress-percent">0%</strong><span>Completed</span></div>
                            </div>
                            <div class="progress-stats">
                                <div class="stat"><p>Chapters Completed</p><strong id="chapters-completed-stat">0 / 0</strong></div>
                                <div class="stat"><p>Assessments</p><strong id="assessments-completed-stat">0 / 0</strong></div>
                            </div>
                        </div>
                    </div>
                    <div class="widget">
                        <div class="widget-header"><h2>Notifications & Deadlines</h2></div>
                        <ul class="notification-list" id="notification-list"></ul>
                    </div>
                    <div class="widget">
                        <div class="widget-header"><h2>Leaderboard</h2><a href="leaderboard.html">View All</a></div>
                        <div class="tab-container">
                            <button class="tab-btn active" data-target="#my-college-content">My College</button>
                            <button class="tab-btn" data-target="#overall-content">Overall</button>
                            <div class="active-line"></div>
                        </div>
                        <div id="my-college-content" class="tab-content active"><ul class="profile-list" id="college-leaderboard-list"></ul></div>
                        <div id="overall-content" class="tab-content"><ul class="profile-list" id="overall-leaderboard-list"></ul></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const firebaseConfig = {
                apiKey: "AIzaSyCSW52Vl2UIC7eeM4uXKcSPdHflZCl3WJQ",
                authDomain: "exam-2e799.firebaseapp.com",
                projectId: "exam-2e799",
                storageBucket: "exam-2e799.firebasestorage.app",
                messagingSenderId: "472506328501",
                appId: "1:472506328501:web:f239c42baed2f4b9f925fc",
                measurementId: "G-NX21HT3JKT"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const ADMIN_EMAIL = "harshavardhanjw@gmail.com";
            const DEFAULT_AVATAR = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRWxmiQqKsGu4P4FulnB-hDH6_RyTFPzHo67Q&s';

            const setupEventListeners = () => {
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                const profileSection = document.getElementById('profile-section');
                const profilePopup = document.getElementById('profile-popup');
                profileSection.addEventListener('click', e => { e.stopPropagation(); profilePopup.classList.toggle('active'); });
                document.addEventListener('click', e => { if (!profileSection.contains(e.target)) { profilePopup.classList.remove('active'); } });
                // Removed Sidebar toggle listeners
            };

            const updateProfileUI = (userProfile) => {
                const logoUrl = localStorage.getItem('dashboardLogoUrl');
                if (logoUrl) { 
                    const logoImg = document.querySelector('.logo-image');
                    if(logoImg) logoImg.src = logoUrl; 
                }
                const profileToUse = userProfile || JSON.parse(localStorage.getItem('dashboardUserProfile'));
                if(profileToUse) {
                    document.querySelectorAll('.profile-avatar').forEach(el => {
                        el.src = profileToUse.photoURL || DEFAULT_AVATAR;
                        el.onerror = () => { el.src = DEFAULT_AVATAR; };
                    });
                    document.querySelectorAll('.profile-name').forEach(el => el.textContent = profileToUse.displayName);
                    document.querySelectorAll('.profile-email').forEach(el => el.textContent = profileToUse.email);
                }
            };
            
            setupEventListeners();
            updateProfileUI();

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    if (user.email === ADMIN_EMAIL) { window.location.href = 'admin.html'; return; }
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) { window.location.href = 'index.html'; return; }
                    const userProfile = userDoc.data();
                    updateProfileUI(userProfile);
                    loadDashboardData(user.uid, userProfile);
                } else { window.location.href = 'index.html'; }
            });

            const initTabs = () => {
                const tabs = document.querySelectorAll('.tab-btn');
                const activeLine = document.querySelector('.active-line');
                function moveActiveLine(tabElement) { if (tabElement) { activeLine.style.width = `${tabElement.offsetWidth}px`; activeLine.style.left = `${tabElement.offsetLeft}px`; } }
                const activeTab = document.querySelector('.tab-btn.active');
                if(activeTab) moveActiveLine(activeTab);
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.querySelector(tab.dataset.target).classList.add('active');
                        moveActiveLine(tab);
                    });
                });
            };

            const loadDashboardData = async (userId, userProfile) => {
                try {
                    const enrollmentsSnap = await db.collection('enrollments').where('userId', '==', userId).get();
                    const enrolledCourseIds = enrollmentsSnap.docs.map(doc => doc.data().courseId);
                    const enrolledSubjectIds = enrollmentsSnap.docs.map(doc => doc.data().subjectId);

                    const [coursesSnap, examsSnap, codeAssignmentsSnap, progressSnap, scoresSnap, usersSnap, subjectsSnap, notificationsSnap, codeAssignmentScoresSnap] = await Promise.all([
                        enrolledCourseIds.length ? db.collection('courses').where(firebase.firestore.FieldPath.documentId(), 'in', enrolledCourseIds).get() : Promise.resolve({ docs: [] }),
                        enrolledSubjectIds.length ? db.collection('exams').where('subjectId', 'in', enrolledSubjectIds).get() : Promise.resolve({ docs: [] }),
                        enrolledSubjectIds.length ? db.collection('codeAssignments').where('subjectId', 'in', enrolledSubjectIds).get() : Promise.resolve({ docs: [] }),
                        db.collection('users').doc(userId).collection('progress').get(),
                        db.collection('scores').get(), db.collection('users').get(),
                        db.collection('subjects').get(), db.collection('notifications').orderBy('createdAt', 'desc').get(),
                        db.collection('codeAssignmentScores').get()
                    ]);
                    
                    const userStandaloneScores = new Map(scoresSnap.docs.filter(d => d.data().userId === userId && d.data().examType !== 'quiz').map(d => [d.data().examId, d.data()]));
                    const userCodeAssignmentScores = new Map(codeAssignmentScoresSnap.docs.filter(d => d.data().userId === userId).map(d => [d.data().assignmentId, d.data()]));
                    
                    const enrolledExams = examsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const enrolledCodeAssignments = codeAssignmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNotifications(notificationsSnap, enrolledExams, enrolledCodeAssignments, userStandaloneScores, userCodeAssignmentScores);

                    const allUsers = new Map(usersSnap.docs.map(doc => [doc.id, doc.data()]));
                    renderLeaderboards(scoresSnap, codeAssignmentScoresSnap, allUsers, userId, userProfile, usersSnap);

                    if (enrollmentsSnap.empty) {
                        document.getElementById('enrollment-prompt').style.display = 'block';
                        document.getElementById('featured-course-widget').style.display = 'none';
                        document.getElementById('course-outline-widget').style.display = 'none';
                        renderOverallProgress(0, 0, 0, 0); 
                    } else {
                        document.getElementById('enrollment-prompt').style.display = 'none';
                        const enrolledCourses = coursesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const userProgress = new Set(progressSnap.docs.map(doc => doc.data().lessonId));
                        const allSubjects = new Map(subjectsSnap.docs.map(doc => [doc.id, doc.data()]));
                        
                        const lessonsPromises = enrolledCourseIds.map(id => db.collection('lessons').where('courseId', '==', id).get());
                        const lessonsSnaps = await Promise.all(lessonsPromises);
                        const allEnrolledLessons = lessonsSnaps.flatMap(snap => snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        
                        let totalChapters = 0;
                        let completedChapters = 0;
                        enrolledCourses.forEach(course => {
                            const courseChapters = course.chapters || [];
                            totalChapters += courseChapters.length;

                            courseChapters.forEach((chapterName, chapterIndex) => {
                                const itemsInChapter = allEnrolledLessons.filter(l => l.courseId === course.id && l.chapterIndex === chapterIndex);
                                if (itemsInChapter.length > 0 && itemsInChapter.every(item => userProgress.has(item.id))) {
                                    completedChapters++;
                                }
                            });
                        });

                        const totalAssessments = enrolledExams.length + enrolledCodeAssignments.length;
                        const completedAssessments = userStandaloneScores.size + userCodeAssignmentScores.size;

                        renderFeaturedCourse(enrolledCourses, allEnrolledLessons, allSubjects, userProgress);
                        renderOverallProgress(totalChapters, totalAssessments, completedChapters, completedAssessments);
                    }
                } catch(error) {
                     console.error("Error loading dashboard data:", error);
                } finally {
                    // Removed skeleton loader toggling logic
                    initTabs();
                }
            };

            const renderFeaturedCourse = (courses, lessons, subjects, progress) => {
                let featuredCourse = courses.find(c => lessons.some(l => l.courseId === c.id && !progress.has(l.id))) || courses[0];
                if (!featuredCourse) return;

                document.getElementById('featured-course-widget').style.display = 'block';
                document.getElementById('course-outline-widget').style.display = 'block';
                const courseLessons = lessons.filter(l => l.courseId === featuredCourse.id).sort((a,b) => a.chapterIndex - b.chapterIndex || a.order - b.order);
                const completed = courseLessons.filter(l => progress.has(l.id)).length;
                const percent = courseLessons.length > 0 ? Math.round((completed / courseLessons.length) * 100) : 0;
                
                document.getElementById('featured-course-title').textContent = featuredCourse.name;
                document.getElementById('featured-course-subject').textContent = `in ${subjects.get(featuredCourse.subjectId)?.name || ''}`;
                document.getElementById('featured-course-progress').style.width = `${percent}%`;
                document.getElementById('featured-course-percent').textContent = `${percent}% Complete`;
                document.getElementById('featured-course-link').href = `lesson-view.html?id=${featuredCourse.id}`;
                
                const outlineList = document.getElementById('course-outline-list');
                const toggleBtn = document.getElementById('toggle-chapters-btn');
                const widget = document.getElementById('course-outline-widget');
                outlineList.innerHTML = '';
                
                const chaptersWithLessons = (featuredCourse.chapters || []).map((name, index) => ({ name, index, lessons: courseLessons.filter(l => l.chapterIndex === index) })).filter(c => c.lessons.length > 0);
                const firstUncompleted = courseLessons.find(l => !progress.has(l.id));
                const currentChapterIndex = firstUncompleted ? firstUncompleted.chapterIndex : -1;
                let lastCompletedChapterIndex = -1;
                chaptersWithLessons.forEach(c => { if (c.lessons.every(l => progress.has(l.id))) lastCompletedChapterIndex = c.index; });

                chaptersWithLessons.forEach((chapter) => {
                    const isChapterCompleted = chapter.lessons.every(l => progress.has(l.id));
                    const isCurrentChapter = chapter.index === currentChapterIndex;
                    const isNextChapter = chapter.index === currentChapterIndex + 1 && currentChapterIndex !== -1;
                    const isLastCompleted = chapter.index === lastCompletedChapterIndex;
                    
                    const item = document.createElement('li');
                    item.className = 'outline-item';
                    if (isChapterCompleted) item.classList.add('completed');
                    if (isCurrentChapter) item.classList.add('current');
                    
                    const completedLessonsInChapter = chapter.lessons.filter(l => progress.has(l.id)).length;
                    item.innerHTML = `<div class="outline-marker">${isChapterCompleted ? "<i class='bx bx-check'></i>" : ''}</div><div class="outline-info"><h4>${chapter.name}</h4><p>${completedLessonsInChapter} / ${chapter.lessons.length} lessons</p></div>`;
                    
                    if(chaptersWithLessons.length > 3 && !isLastCompleted && !isCurrentChapter && !isNextChapter) item.style.display = 'none';
                    outlineList.appendChild(item);
                });

                if (chaptersWithLessons.length > 3) {
                    toggleBtn.style.display = 'inline-block';
                    let isShowingAll = false;
                    const initiallyVisibleItems = outlineList.querySelectorAll('.outline-item[style*="display: flex"], .outline-item:not([style])');
                    if(initiallyVisibleItems.length <= 3) widget.style.paddingBottom = '0.5rem';

                    toggleBtn.onclick = (e) => {
                        e.preventDefault();
                        isShowingAll = !isShowingAll;
                        toggleBtn.textContent = isShowingAll ? 'Show Less' : 'Show All';
                        widget.style.paddingBottom = isShowingAll ? '1.5rem' : '0.5rem';
                        
                        outlineList.querySelectorAll('.outline-item').forEach((item, itemIndex) => {
                            if (isShowingAll) item.style.display = 'flex';
                            else {
                                const chapter = chaptersWithLessons[itemIndex];
                                const isCurrentChapter = chapter.index === currentChapterIndex;
                                const isNextChapter = chapter.index === currentChapterIndex + 1 && currentChapterIndex !== -1;
                                const isLastCompleted = chapter.index === lastCompletedChapterIndex;
                                if (!isLastCompleted && !isCurrentChapter && !isNextChapter) item.style.display = 'none';
                            }
                        });
                    };
                } else {
                    toggleBtn.style.display = 'none';
                }
            };
            
            const renderOverallProgress = (totalChapters, totalAssessments, completedChapters, completedAssessments) => {
                const overallPercent = (totalChapters + totalAssessments > 0) ? Math.round(((completedChapters + completedAssessments) / (totalChapters + totalAssessments)) * 100) : 0;
                document.getElementById('chapters-completed-stat').textContent = `${completedChapters} / ${totalChapters}`;
                document.getElementById('assessments-completed-stat').textContent = `${completedAssessments} / ${totalAssessments}`;
                document.getElementById('overall-progress-percent').textContent = `${overallPercent}%`;
                const ring = document.getElementById('overall-progress-ring');
                const radius = ring.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                ring.style.strokeDasharray = `${circumference} ${circumference}`;
                const offset = circumference - (overallPercent / 100) * circumference;
                ring.style.strokeDashoffset = offset;
            };

            const renderLeaderboards = async (scoresSnap, codeAssignmentScoresSnap, users, currentUserId, currentUserProfile, usersSnap) => {
                const userPoints = {};
                users.forEach((profile, id) => userPoints[id] = 0);
                scoresSnap.forEach(doc => { const score = doc.data(); userPoints[score.userId] = (userPoints[score.userId] || 0) + score.pointsReceived; });
                codeAssignmentScoresSnap.forEach(doc => { const score = doc.data(); userPoints[score.userId] = (userPoints[score.userId] || 0) + score.totalScoreObtained; });
                
                const attendancePromises = usersSnap.docs.map(userDoc => 
                    db.collection('users').doc(userDoc.id).collection('scores').doc('attendance').get()
                );
                const attendanceSnaps = await Promise.all(attendancePromises);

                attendanceSnaps.forEach((doc, index) => {
                    const userId = usersSnap.docs[index].id;
                    if (doc.exists && userPoints[userId] !== undefined) {
                        const attendanceData = doc.data();
                        Object.keys(attendanceData).forEach(key => {
                            if (!isNaN(Date.parse(key))) {
                                userPoints[userId] += attendanceData[key] || 0;
                            }
                        });
                    }
                });

                const sortedUsers = Object.keys(userPoints).filter(id => users.has(id)).sort((a,b) => userPoints[b] - userPoints[a]);
                
                const createLeaderboardHTML = (userList) => {
                    let html = '';
                    let currentUserRendered = false;
                    userList.slice(0, 3).forEach((userId, index) => {
                        if(userId === currentUserId) currentUserRendered = true;
                        const user = users.get(userId);
                        if(user) {
                            const photoURL = user.photoURL || DEFAULT_AVATAR;
                            html += `<li class="profile-item"><span class="rank">${index + 1}</span><img src="${photoURL}" alt="${user.displayName}" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}';"><div class="profile-info"><p class="profile-name">${user.displayName}${userId === currentUserId ? ' (You)' : ''}</p><p class="profile-affiliation">${user.college}</p></div><span class="score">${index === 0 ? "<i class='bx bxs-crown crown'></i>": ""} ${userPoints[userId] || 0} XP</span></li>`;
                        }
                    });
                    
                    const currentUserRank = userList.indexOf(currentUserId);
                    if (!currentUserRendered && currentUserRank >= 3) {
                         const user = users.get(currentUserId);
                         if (user) {
                            html += `<hr class="user-separator"><li class="profile-item"><span class="rank">${currentUserRank + 1}</span><img src="${user.photoURL || DEFAULT_AVATAR}" alt="${user.displayName}" onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}';"><div class="profile-info"><p class="profile-name">${user.displayName} (You)</p><p class="profile-affiliation">${user.college}</p></div><span class="score">${userPoints[currentUserId] || 0} XP</span></li>`;
                         }
                    }
                    return html || '<p class="placeholder-text">No data available yet.</p>';
                };
                document.getElementById('overall-leaderboard-list').innerHTML = createLeaderboardHTML(sortedUsers);
                const collegeUsers = sortedUsers.filter(userId => users.get(userId)?.college === currentUserProfile.college);
                document.getElementById('college-leaderboard-list').innerHTML = createLeaderboardHTML(collegeUsers);
            };

            const renderNotifications = (notificationsSnap, enrolledExams, enrolledCodeAssignments, userScores, userCodeAssignmentScores) => {
                const list = document.getElementById('notification-list');
                const oneDay = 1000 * 60 * 60 * 24;
                const threeDays = oneDay * 3;
                const now = new Date();
                const items = [];
                notificationsSnap.forEach(doc => { items.push({ type: 'general', data: doc.data(), docId: doc.id, timestamp: doc.data().createdAt }); });

                enrolledExams.forEach(exam => {
                    if (exam.deadline && !exam.isLocked && !userScores.has(exam.id)) {
                        const deadlineDate = new Date(exam.deadline.seconds * 1000);
                        const diff = deadlineDate - now;
                        if (diff > 0 && diff <= threeDays) items.push({ type: 'exam', data: exam, docId: exam.id, timestamp: exam.deadline, diff: diff });
                    }
                });
                
                enrolledCodeAssignments.forEach(assignment => {
                    if (assignment.deadline && !assignment.isLocked && !userCodeAssignmentScores.has(assignment.id)) {
                        const deadlineDate = new Date(assignment.deadline.seconds * 1000);
                        const diff = deadlineDate - now;
                        if (diff > 0 && diff <= threeDays) items.push({ type: 'code', data: assignment, docId: assignment.id, timestamp: assignment.deadline, diff: diff });
                    }
                });

                items.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                list.innerHTML = '';
                
                if (items.length === 0) { list.parentElement.innerHTML = '<div class="widget-header"><h2>Notifications & Deadlines</h2></div><p class="placeholder-text">No notifications at this time.</p>'; return; }

                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'notification-item';
                    let iconClass, icon, heading, text, buttonHtml = '';
                    if (item.type === 'general') {
                        iconClass = 'general'; icon = "<i class='bx bxs-bell'></i>"; heading = item.data.heading; text = item.data.text;
                        if (item.data.buttonText && item.data.buttonLink) buttonHtml = `<a href="${item.data.buttonLink}" class="btn-notification">${item.data.buttonText}</a>`;
                    } else {
                        const daysLeft = Math.ceil(item.diff / oneDay);
                        if (item.diff <= oneDay) { iconClass = 'danger'; icon = "<i class='bx bxs-error-circle'></i>"; text = `Deadline is in less than 24 hours.`; } 
                        else { iconClass = 'warning'; icon = "<i class='bx bxs-error-alt'></i>"; text = `Deadline is in ${daysLeft} days.`; }
                        heading = `${item.data.name} Deadline`;
                        const link = item.type === 'exam' ? `exam.html?id=${item.docId}` : `code.html?id=${item.docId}`;
                        buttonHtml = `<a href="${link}" class="btn-notification">Start Now</a>`;
                    }
                    li.innerHTML = `<div class="notification-content"><div class="notification-icon ${iconClass}">${icon}</div><div class="notification-info"><h4>${heading}</h4><p>${text}</p></div></div>${buttonHtml}`;
                    list.appendChild(li);
                });
            };
        });
    </script>
</body>
</html>
