<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Ihtnas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root { 
            --body-bg: #F3F4F6; --widget-bg: #FFFFFF; --border-color: #E5E7EB; 
            --text-primary: #111827; --text-secondary: #4B5563; --brand-purple: #6D28D9; 
            --brand-purple-light: #F5F3FF; --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: var(--body-bg); color: var(--text-primary); font-size: 14px; }

        /* Header & Navbar */
        .header { background: var(--widget-bg); padding: 0.75rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        /* Course Selector Styles */
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .course-selector-container { position: relative; }
        .btn-course-switch { 
            background: var(--brand-purple-light); color: var(--brand-purple); 
            border: 1px solid var(--brand-purple); padding: 8px 16px; border-radius: 10px; 
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn-course-switch:hover { background: #EDE9FE; }
        
        .course-dropdown { 
            position: absolute; top: calc(100% + 10px); left: 0; width: 250px; 
            background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
            border: 1px solid var(--border-color); display: none; z-index: 200; overflow: hidden;
        }
        .course-dropdown.active { display: block; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid #f3f3f3; }
        .dropdown-item:hover { background: var(--hover-bg); }
        .dropdown-item i { color: var(--brand-purple); font-size: 1.2rem; }
        .dropdown-item.add-new { background: #fafafa; color: var(--text-secondary); font-weight: 600; justify-content: center; }
        .dropdown-item.add-new:hover { color: var(--brand-purple); }

        .profile-trigger { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px; border-radius: 12px; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #ddd; }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; display: grid; grid-template-columns: 1fr 350px; gap: 2rem; }

        /* Widget Styles */
        .widget { background: var(--widget-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .widget-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 8px; }

        /* Dashboard Hero Card */
        .hero-card { background: linear-gradient(135deg, #6D28D9 0%, #4C1D95 100%); color: white; border: none; }
        .hero-card h4 { opacity: 0.8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .hero-card h2 { font-size: 1.5rem; margin: 0.5rem 0 1rem 0; }
        .progress-container { background: rgba(255,255,255,0.2); height: 8px; border-radius: 10px; margin-bottom: 1.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }
        .btn-continue { background: white; color: var(--brand-purple); padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 700; display: inline-block; }

        /* Leaderboard */
        .leader-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f8f8f8; }
        .xp { font-weight: 700; color: var(--success); margin-left: auto; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="nav-left">
            <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" class="logo" onclick="window.location.href='student-dashboard.html'">
            
            <!-- Contextual Course Selector -->
            <div class="course-selector-container">
                <button class="btn-course-switch" onclick="toggleCourseDropdown()">
                    <i class='bx bx-book-bookmark'></i>
                    <span id="current-course-name">Select Course</span>
                    <i class='bx bx-chevron-down'></i>
                </button>
                <div class="course-dropdown" id="course-dropdown">
                    <div id="enrolled-list">
                        <!-- Enrolled courses list -->
                    </div>
                    <div class="dropdown-item add-new" onclick="window.location.href='courses.html'">
                        <i class='bx bx-plus-circle'></i> Enroll in More
                    </div>
                </div>
            </div>
        </div>

        <div class="profile-trigger" onclick="window.location.href='profile.html'">
            <div style="text-align: right; margin-right: 10px;" class="desktop-only">
                <p id="user-name" style="font-weight: 700;">Loading...</p>
                <p id="user-xp" style="font-size: 0.75rem; color: var(--success); font-weight: 600;">0 XP</p>
            </div>
            <img src="" id="user-avatar" class="avatar">
        </div>
    </header>

    <div class="container">
        <!-- Main Column -->
        <div class="main-content">
            <!-- Hero Progress Card -->
            <div class="widget hero-card" id="hero-widget">
                <h4 id="course-label">YOUR PROGRESS</h4>
                <h2 id="lesson-title">Welcome Back!</h2>
                <div class="progress-container">
                    <div class="progress-fill" id="course-progress-bar"></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span id="progress-text">0% Completed</span>
                    <a href="#" id="continue-btn" class="btn-continue">Continue Learning</a>
                </div>
            </div>

            <!-- Detailed Outline -->
            <div class="widget">
                <h3 class="widget-title"><i class='bx bx-list-ul'></i> Course Curriculum</h3>
                <div id="curriculum-list">
                    <!-- Chapters and Lessons here -->
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Course Specific Streak/Stats -->
            <div class="widget">
                <h3 class="widget-title"><i class='bx bxs-zap' style="color:var(--warning)"></i> Activity Stats</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:center">
                    <div style="background:var(--brand-purple-light); padding:15px; border-radius:12px;">
                        <strong id="stat-lessons" style="font-size:1.5rem; color:var(--brand-purple)">0</strong>
                        <p style="font-size:0.7rem; color:var(--text-secondary); margin-top:5px">Lessons Done</p>
                    </div>
                    <div style="background:#ECFDF5; padding:15px; border-radius:12px;">
                        <strong id="stat-exams" style="font-size:1.5rem; color:var(--success)">0</strong>
                        <p style="font-size:0.7rem; color:var(--text-secondary); margin-top:5px">Exams Taken</p>
                    </div>
                </div>
            </div>

            <!-- Course Specific Leaderboard -->
            <div class="widget">
                <h3 class="widget-title"><i class='bx bxs-trophy' style="color: var(--warning);"></i> Course Ranking</h3>
                <div id="leaderboard-list">
                    <!-- Filtered leaderboard items -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let selectedCourseId = localStorage.getItem('selectedCourseId');
        let enrolledCourses = [];

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            currentUser = session.user;

            await fetchEnrollments();
            if (enrolledCourses.length > 0) {
                // Default to first enrollment if nothing saved in localStorage
                if (!selectedCourseId || !enrolledCourses.find(c => c.course_id === selectedCourseId)) {
                    selectedCourseId = enrolledCourses[0].course_id;
                    localStorage.setItem('selectedCourseId', selectedCourseId);
                }
                loadCourseContext();
            } else {
                window.location.href = 'courses.html';
            }
        }

        async function fetchEnrollments() {
            const { data } = await supabaseClient
                .from('enrollments')
                .select('course_id, courses(name, language)')
                .eq('user_id', currentUser.id);
            
            enrolledCourses = data || [];
            renderCourseSwitcher();
        }

        function renderCourseSwitcher() {
            const container = document.getElementById('enrolled-list');
            const currentNameDisplay = document.getElementById('current-course-name');
            
            container.innerHTML = enrolledCourses.map(e => {
                if(e.course_id === selectedCourseId) currentNameDisplay.innerText = e.courses.name;
                return `
                    <div class="dropdown-item" onclick="switchCourse('${e.course_id}')">
                        <i class='bx bx-chevron-right-square'></i> ${e.courses.name}
                    </div>
                `;
            }).join('');
        }

        function toggleCourseDropdown() {
            document.getElementById('course-dropdown').classList.toggle('active');
        }

        function switchCourse(id) {
            localStorage.setItem('selectedCourseId', id);
            window.location.reload(); // Reload to refresh all filtered data
        }

        async function loadCourseContext() {
            // Load user profile
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if(profile) {
                document.getElementById('user-name').innerText = profile.full_name;
                document.getElementById('user-avatar').src = profile.avatar_url || 'https://ui-avatars.com/api/?name=' + profile.full_name;
            }

            // 1. Calculate Progress for THIS course
            const { count: totalLessons } = await supabaseClient.from('lessons').select('*', { count: 'exact', head: true }).eq('course_id', selectedCourseId);
            const { data: progressData } = await supabaseClient.from('lessons').select('id').eq('course_id', selectedCourseId);
            const lessonIds = progressData.map(l => l.id);
            
            const { count: completedLessons } = await supabaseClient.from('progress')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id)
                .in('content_node_id', lessonIds);

            const percent = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
            document.getElementById('course-progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').innerText = percent + '% Completed';
            document.getElementById('stat-lessons').innerText = completedLessons;

            // 2. Load Leaderboard specifically for THIS course
            // (Note: In a real app, you'd sum points from score tables filtered by course_id)
            const { data: rankings } = await supabaseClient.from('profiles')
                .select('full_name, total_points, avatar_url')
                .order('total_points', { ascending: false }).limit(5);

            document.getElementById('leaderboard-list').innerHTML = rankings.map((r, i) => `
                <div class="leader-item">
                    <span style="font-weight:700; width:20px; color:#999">${i+1}</span>
                    <span class="name">${r.full_name}</span>
                    <span class="xp">${r.total_points} XP</span>
                </div>
            `).join('');

            // 3. Update Course Outline UI
            const { data: chapters } = await supabaseClient.from('courses').select('chapters').eq('id', selectedCourseId).single();
            const curriculumContainer = document.getElementById('curriculum-list');
            curriculumContainer.innerHTML = chapters.chapters.map((ch, i) => `
                <div style="padding:10px; border-radius:8px; background:#f9f9f9; margin-bottom:5px; font-weight:600">
                    Chapter ${i+1}: ${ch}
                </div>
            `).join('');
        }

        // Close dropdown when clicking outside
        window.onclick = function(e) {
            if (!e.target.closest('.course-selector-container')) {
                document.getElementById('course-dropdown').classList.remove('active');
            }
        }

        init();
    </script>
</body>
</html>
