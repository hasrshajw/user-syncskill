<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | Ihtnas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root { 
            --body-bg: #F3F4F6; --widget-bg: #FFFFFF; --border-color: #E5E7EB; 
            --text-primary: #111827; --text-secondary: #4B5563; --brand-purple: #6D28D9; 
            --brand-purple-light: #F5F3FF; --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: var(--body-bg); color: var(--text-primary); font-size: 14px; -webkit-font-smoothing: antialiased; }

        /* Header Navigation */
        .header { background: var(--widget-bg); padding: 0.75rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .course-switcher { position: relative; }
        .course-select-trigger { 
            display: flex; align-items: center; gap: 10px; background: var(--brand-purple-light); 
            padding: 8px 16px; border-radius: 12px; cursor: pointer; border: 1px solid rgba(109, 40, 217, 0.1);
            font-weight: 700; color: var(--brand-purple); transition: all 0.2s;
        }
        .course-select-trigger:hover { background: #EDE9FE; }
        
        .course-dropdown { 
            position: absolute; top: 120%; left: 0; width: 280px; background: white; 
            border-radius: 14px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            border: 1px solid var(--border-color); display: none; z-index: 200; overflow: hidden;
        }
        .course-dropdown.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .course-item { padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; border-bottom: 1px solid #f9f9f9; }
        .course-item:hover { background: #F9FAFB; }
        .course-item.active { background: var(--brand-purple-light); color: var(--brand-purple); border-left: 4px solid var(--brand-purple); }
        .btn-browse { background: #fafafa; color: var(--text-secondary); font-weight: 700; justify-content: center; border-top: 1px solid var(--border-color); }

        .profile-area { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid var(--border-color); }
        
        /* Layout Grid */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; display: grid; grid-template-columns: 1fr 350px; gap: 2rem; }
        .widget { background: var(--widget-bg); border-radius: 20px; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .widget-title { font-size: 0.85rem; font-weight: 800; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; }

        /* Featured Card */
        .continue-card { background: linear-gradient(135deg, #6D28D9 0%, #4C1D95 100%); color: white; border: none; position: relative; overflow: hidden; }
        .continue-card::after { content: '\eb0c'; font-family: 'boxicons'; position: absolute; right: -20px; bottom: -20px; font-size: 10rem; opacity: 0.1; }
        .btn-resume { background: white; color: var(--brand-purple); padding: 14px 28px; border-radius: 12px; text-decoration: none; font-weight: 800; display: inline-block; margin-top: 1.5rem; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-resume:hover { transform: translateY(-2px); }

        /* Syllabus */
        .syllabus-scroll { max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .syllabus-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 4px; }
        .syllabus-row:hover { background: #F9FAFB; }
        .syllabus-row i { font-size: 1.25rem; }
        .syllabus-row.done { color: var(--text-secondary); opacity: 0.8; }

        /* Ranking */
        .rank-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
        .rank-num { width: 28px; font-weight: 800; color: #9CA3AF; font-size: 1.1rem; }
        .xp-pill { background: var(--brand-purple-light); color: var(--brand-purple); padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 0.75rem; }

        /* Loaders */
        #loading-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 800; }
        #no-course-ui { display: none; text-align: center; padding: 8rem 2rem; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .header-stats { display: none; } }
    </style>
</head>
<body>

    <div id="loading-overlay">VERIFYING STUDENT CREDENTIALS...</div>

    <header class="header">
        <div class="course-switcher">
            <div class="course-select-trigger" onclick="toggleCourseMenu()">
                <i class='bx bx-book-content'></i>
                <span id="active-course-label">Syncing...</span>
                <i class='bx bx-chevron-down'></i>
            </div>
            <div class="course-dropdown" id="course-dropdown">
                <div id="enrollment-list"></div>
                <div class="course-item btn-browse" onclick="window.location.href='courses.html'">
                    <i class='bx bx-search-alt'></i> Browse New Courses
                </div>
            </div>
        </div>

        <div class="profile-area" onclick="window.location.href='profile.html'">
            <div class="header-stats" style="text-align: right; margin-right: 12px;">
                <p id="student-name" style="font-weight: 800; font-size: 1rem;">Student</p>
                <p id="course-xp-val" style="font-size: 0.75rem; color: var(--brand-purple); font-weight: 800;">0 XP (Course)</p>
            </div>
            <img src="" id="student-avatar" class="user-avatar">
        </div>
    </header>

    <div class="container" id="dashboard-main" style="display: none;">
        <div class="left-col">
            <!-- Continue Learning -->
            <div class="widget continue-card">
                <h4 style="font-size: 0.7rem; letter-spacing: 1.5px;">RESUME YOUR GOAL</h4>
                <h2 id="resume-lesson-title" style="font-size: 1.8rem; margin-top: 5px;">Starting your journey...</h2>
                <p id="resume-course-name" style="opacity: 0.8; font-weight: 500;"></p>
                <a href="#" id="resume-btn" class="btn-resume" style="display: none;">Continue Learning</a>
            </div>

            <!-- Optimized Syllabus -->
            <div class="widget">
                <h3 class="widget-title"><i class='bx bx-list-check'></i> My Progress & Syllabus</h3>
                <div id="syllabus-list" class="syllabus-scroll"></div>
            </div>
        </div>

        <div class="right-col">
            <!-- Streak -->
            <div class="widget">
                <h3 class="widget-title"><i class='bx bxs-flame' style="color: #FF5722;"></i> Daily Streak</h3>
                <div style="text-align: center; background: var(--brand-purple-light); padding: 1.5rem; border-radius: 16px;">
                    <strong id="streak-val" style="font-size: 3rem; color: var(--brand-purple); display: block;">0</strong>
                    <span style="color: #6B7280; font-weight: 700; font-size: 0.85rem;">Continuous Days</span>
                </div>
            </div>

            <!-- Ranking -->
            <div class="widget">
                <h3 class="widget-title"><i class='bx bxs-trophy' style="color: var(--warning);"></i> Course Rankings</h3>
                <div id="leaderboard-target">No rankings yet.</div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="no-course-ui">
        <i class='bx bx-book-open' style="font-size: 5rem; color: #ccc;"></i>
        <h2 style="margin-top: 1.5rem;">Begin Your Learning</h2>
        <p style="color: #6B7280; margin-bottom: 2rem;">You need to enroll in a course to access this dashboard.</p>
        <a href="courses.html" class="btn-resume" style="background: var(--brand-purple); color: white;">Explore Courses</a>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
    const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null;
    let activeId = localStorage.getItem('active_course_id');

    const ui = (id, val, text = false) => {
        const el = document.getElementById(id);
        if (el) text ? el.innerText = val : el.innerHTML = val;
    };

    document.addEventListener('DOMContentLoaded', startApp);

    async function startApp() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'login.html'; return; }
        user = session.user;

        // Sync streak
        await supabase.from('daily_activity').upsert(
            { user_id: user.id, activity_date: new Date().toISOString().split('T')[0] },
            { onConflict: 'user_id,activity_date' }
        );

        // Load Enrollments & handle Orphaned State Fallback
        const hasAccess = await syncEnrollmentContext();
        
        if (hasAccess) {
            document.getElementById('dashboard-main').style.display = 'grid';
            document.getElementById('no-course-ui').style.display = 'none';
            await refreshUI();
        } else {
            document.getElementById('dashboard-main').style.display = 'none';
            document.getElementById('no-course-ui').style.display = 'block';
        }

        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function syncEnrollmentContext() {
        const { data: enrolls, error } = await supabase
            .from('enrollments')
            .select('course_id, courses(name)')
            .eq('user_id', user.id);

        if (error || !enrolls || enrolls.length === 0) return false;

        // FIX: Orphaned State Logic
        const stillInList = enrolls.find(e => e.course_id === activeId);
        if (!activeId || !stillInList) {
            activeId = enrolls[0].course_id;
            localStorage.setItem('active_course_id', activeId);
        }

        const current = enrolls.find(e => e.course_id === activeId);
        ui('active-course-label', current.courses.name, true);

        // Populate Switcher
        ui('enrollment-list', enrolls.map(e => `
            <div class="course-item ${e.course_id === activeId ? 'active' : ''}" 
                 onclick="changeCourse('${e.course_id}')">
                <span>${e.courses.name}</span>
                ${e.course_id === activeId ? "<i class='bx bxs-check-circle'></i>" : ""}
            </div>
        `).join(''));

        return true;
    }

    async function changeCourse(id) {
        if (id === activeId) return;
        ui('syllabus-list', 'Synchronizing...');
        ui('leaderboard-target', 'Syncing...');
        document.getElementById('resume-btn').style.display = 'none';
        
        localStorage.setItem('active_course_id', id);
        activeId = id;
        document.getElementById('course-dropdown').classList.remove('active');
        
        await syncEnrollmentContext();
        await refreshUI();
    }

    async function refreshUI() {
        await Promise.all([
            loadStudentProfile(),
            loadCourseXP(),
            loadSyllabus(),
            loadRanking(),
            loadResumePointer()
        ]);
    }

    async function loadStudentProfile() {
        const { data: p } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
        if (p) {
            ui('student-name', p.full_name || 'Student', true);
            ui('streak-val', p.current_streak || 0, true);
            const av = document.getElementById('student-avatar');
            if (av) av.src = p.avatar_url || `https://ui-avatars.com/api/?name=${p.full_name}`;
        }
    }

    async function loadCourseXP() {
        const { data } = await supabase.from('course_scores').select('points').eq('user_id', user.id).eq('course_id', activeId).maybeSingle();
        ui('course-xp-val', `${data?.points || 0} XP (In Course)`, true);
    }

    async function loadSyllabus() {
        // FIX: Heavy Payload - only select required columns
        const [cRes, lRes, pRes] = await Promise.all([
            supabase.from('courses').select('chapters').eq('id', activeId).single(),
            supabase.from('lessons').select('id, title, chapter_index, order_index, type').eq('course_id', activeId).order('order_index'),
            supabase.from('progress').select('content_node_id').eq('user_id', user.id)
        ]);

        const done = new Set(pRes.data?.map(p => p.content_node_id));
        let html = '';

        if(cRes.data && lRes.data) {
            cRes.data.chapters.forEach((name, idx) => {
                const lessons = lRes.data.filter(l => l.chapter_index === idx);
                if (lessons.length === 0) return;

                html += `<div style="margin-top:20px;"><strong style="color:var(--brand-purple); font-size:0.7rem;">${name}</strong>`;
                lessons.forEach(l => {
                    const isDone = done.has(l.id);
                    html += `
                        <div class="syllabus-row ${isDone ? 'done' : ''}" onclick="window.location.href='lesson-view.html?id=${l.id}&course=${activeId}'">
                            <i class='bx ${isDone ? 'bxs-check-circle' : 'bx-circle'}' style="color: ${isDone ? 'var(--success)' : '#ccc'}"></i>
                            <span style="${isDone ? 'text-decoration:line-through;' : 'font-weight:600;'}">${l.title}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            });
        }
        ui('syllabus-list', html || 'Curriculum structure not found.');
    }

    async function loadRanking() {
        const { data } = await supabase
            .from('course_scores')
            .select(`points, profiles(full_name, college_name)`)
            .eq('course_id', activeId)
            .order('points', { ascending: false })
            .limit(5);

        if (!data || data.length === 0) {
            ui('leaderboard-target', '<p style="color:#999; font-style:italic;">No rankings for this course.</p>');
            return;
        }

        ui('leaderboard-target', data.map((e, idx) => `
            <div class="rank-row">
                <span class="rank-num">${idx + 1}</span>
                <div style="flex:1">
                    <p style="font-weight:700;">${e.profiles?.full_name || 'Anonymous'}</p>
                    <small style="color:#999; font-size:0.7rem;">${e.profiles?.college_name || 'Student'}</small>
                </div>
                <span class="xp-pill">${e.points || 0} XP</span>
            </div>
        `).join(''));
    }

    async function loadResumePointer() {
        const { data: en } = await supabase.from('enrollments').select('*, courses(name)').eq('user_id', user.id).eq('course_id', activeId).single();
        if (en) {
            ui('resume-course-name', en.courses.name, true);
            const btn = document.getElementById('resume-btn');
            if (en.last_accessed_node_id) {
                const { data: l } = await supabase.from('lessons').select('title').eq('id', en.last_accessed_node_id).maybeSingle();
                ui('resume-lesson-title', l ? l.title : 'Ready to continue?', true);
                btn.href = `lesson-view.html?id=${en.last_accessed_node_id}&course=${activeId}`;
                btn.innerText = "Continue Lesson";
            } else {
                ui('resume-lesson-title', 'Ready to Start?', true);
                btn.href = `view-course.html?id=${activeId}`;
                btn.innerText = "View Syllabus";
            }
            btn.style.display = 'inline-block';
        }
    }

    function toggleCourseMenu() { document.getElementById('course-dropdown').classList.toggle('active'); }
    window.onclick = e => { if (!e.target.closest('.course-switcher')) document.getElementById('course-dropdown')?.classList.remove('active'); };

</script>
</body>
</html>
