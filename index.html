<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Profile Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .hidden { display: none !important; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-xl border border-gray-100">
        
        <!-- SECTION 1: LOGIN -->
        <div id="section-login">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Welcome</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full px-4 py-2 border rounded-md outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border rounded-md outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="handleEmailLogin()" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition">Continue</button>
                <div class="text-center text-gray-400 text-sm">OR</div>
                <button onclick="handleGoogleLogin()" class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-md bg-white hover:bg-gray-50 transition">
                    <img class="h-5 w-5 mr-2" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
                    Google
                </button>
            </div>
        </div>

        <!-- SECTION 2: PROFILE FORM (Onboarding / Edit) -->
        <div id="section-form" class="hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Complete Your Profile</h2>
            <div class="space-y-3">
                <input type="text" id="form-name" placeholder="Full Name" class="w-full px-4 py-2 border rounded-md">
                <input type="text" id="form-roll" placeholder="Roll Number" class="w-full px-4 py-2 border rounded-md">
                <input type="text" id="form-mobile" placeholder="Mobile Number" class="w-full px-4 py-2 border rounded-md">
                <input type="text" id="form-college" placeholder="College Name" class="w-full px-4 py-2 border rounded-md">
                <button onclick="saveProfile()" class="w-full bg-green-600 text-white py-2 rounded-md font-semibold hover:bg-green-700">Save Details</button>
                <button onclick="checkProfile()" class="w-full text-gray-500 text-sm underline mt-2">Cancel</button>
            </div>
        </div>

        <!-- SECTION 3: PROFILE VIEW (Dashboard) -->
        <div id="section-view" class="hidden text-center">
            <div class="bg-green-100 text-green-700 p-2 rounded-md mb-4 text-sm font-bold">Login Successfully!</div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800" id="view-name-title">Hello!</h2>
            <div class="text-left space-y-2 mb-6 bg-gray-50 p-4 rounded-lg border">
                <p class="text-sm text-gray-500">Roll Number: <span id="view-roll" class="text-gray-800 font-medium">-</span></p>
                <p class="text-sm text-gray-500">Mobile: <span id="view-mobile" class="text-gray-800 font-medium">-</span></p>
                <p class="text-sm text-gray-500">College: <span id="view-college" class="text-gray-800 font-medium">-</span></p>
                <p class="text-sm text-gray-500">Email: <span id="view-email" class="text-gray-800 font-medium">-</span></p>
            </div>
            <div class="flex flex-col gap-2">
                <button onclick="showEditForm()" class="w-full bg-blue-100 text-blue-700 py-2 rounded-md font-semibold hover:bg-blue-200">Edit Profile</button>
                <button onclick="handleLogout()" class="text-red-500 text-sm underline">Sign Out</button>
            </div>
        </div>

        <p id="msg" class="mt-4 text-center text-xs font-bold uppercase"></p>
    </div>

    <script>
        // 1. YOUR CREDENTIALS
        const SUPABASE_URL = 'https://knfypqztuiemawullipi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb';

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // UI Selectors
        const secLogin = document.getElementById('section-login');
        const secForm = document.getElementById('section-form');
        const secView = document.getElementById('section-view');
        const msgEl = document.getElementById('msg');

        // Check auth on load
        sb.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                checkProfile(); // Check if user has data in DB
            } else {
                showSection('login');
            }
        });

        // AUTH FUNCTIONS
        async function handleEmailLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            setMsg("Processing...", "blue");
            const { error } = await sb.auth.signInWithPassword({ email, password });
            if (error) {
                const { error: signUpError } = await sb.auth.signUp({ email, password });
                if (signUpError) setMsg(signUpError.message, "red");
                else setMsg("Check email for verification link!", "blue");
            }
        }

        async function handleGoogleLogin() {
            await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href } });
        }

        async function handleLogout() {
            await sb.auth.signOut();
            location.reload();
        }

        // DATABASE FUNCTIONS
        async function checkProfile() {
            const user = (await sb.auth.getUser()).data.user;
            if (!user) return;

            setMsg("Loading data...", "gray");
            const { data, error } = await sb.from('profiles').select('*').eq('id', user.id).single();

            if (data) {
                // If user exists in DB, show data
                document.getElementById('view-name-title').innerText = `Hello, ${data.full_name}!`;
                document.getElementById('view-roll').innerText = data.roll_number;
                document.getElementById('view-mobile').innerText = data.mobile;
                document.getElementById('view-college').innerText = data.college;
                document.getElementById('view-email').innerText = user.email;
                showSection('view');
                setMsg("");
            } else {
                // If user is new, show form
                showSection('form');
                setMsg("New user detected. Please fill profile.", "orange");
            }
        }

        async function saveProfile() {
            const user = (await sb.auth.getUser()).data.user;
            const profileData = {
                id: user.id,
                full_name: document.getElementById('form-name').value,
                roll_number: document.getElementById('form-roll').value,
                mobile: document.getElementById('form-mobile').value,
                college: document.getElementById('form-college').value,
                updated_at: new Date()
            };

            setMsg("Saving...", "blue");
            const { error } = await sb.from('profiles').upsert(profileData);

            if (error) setMsg(error.message, "red");
            else checkProfile();
        }

        // NAVIGATION
        function showSection(name) {
            secLogin.classList.add('hidden');
            secForm.classList.add('hidden');
            secView.classList.add('hidden');
            if (name === 'login') secLogin.classList.remove('hidden');
            if (name === 'form') secForm.classList.remove('hidden');
            if (name === 'view') secView.classList.remove('hidden');
        }

        function showEditForm() {
            // Pre-fill form with existing view data
            document.getElementById('form-name').value = document.getElementById('view-name-title').innerText.replace('Hello, ', '').replace('!', '');
            document.getElementById('form-roll').value = document.getElementById('view-roll').innerText;
            document.getElementById('form-mobile').value = document.getElementById('view-mobile').innerText;
            document.getElementById('form-college').value = document.getElementById('view-college').innerText;
            showSection('form');
        }

        function setMsg(txt, color) {
            msgEl.innerText = txt;
            msgEl.style.color = color;
        }
    </script>
</body>
</html>
