<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Assessment - Ihtnas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --bg-dark: #0d1117; --surface-dark: #161b22; --border-color: #30363d;
            --text-primary: #c9d1d9; --text-secondary: #8b949e; --brand-purple: #6D28D9;
            --success: #238636; --danger: #da3633; --warning: #f1e05a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: var(--bg-dark); color: var(--text-primary); height: 100vh; overflow: hidden; }

        /* IDE Layout */
        .ide-wrapper { display: flex; flex-direction: column; height: 100vh; }
        .ide-header { height: 60px; background: var(--surface-dark); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr 300px; flex: 1; overflow: hidden; }

        /* Panels */
        .panel { background: var(--surface-dark); border-right: 1px solid var(--border-color); overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; }
        .problem-info h2 { color: #fff; margin-bottom: 1rem; font-size: 1.2rem; }
        .problem-info p { line-height: 1.6; color: var(--text-secondary); margin-bottom: 1rem; }
        .test-case-box { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-top: 10px; font-family: 'Fira Code', monospace; font-size: 0.8rem; border: 1px solid var(--border-color); }

        /* Editor */
        #editor-container { flex: 1; background: #000; }

        /* Right Panel: Navigator & Results */
        .right-panel { border-left: 1px solid var(--border-color); border-right: none; }
        .nav-item { padding: 12px; border-radius: 8px; background: #21262d; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .nav-item:hover { border-color: var(--brand-purple); }
        .nav-item.active { background: var(--brand-purple); color: white; }
        .nav-item.submitted { opacity: 0.6; pointer-events: none; border-color: var(--success); }

        /* Result View (MCQ Style) */
        #result-view { position: fixed; inset: 0; background: var(--bg-dark); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .result-card { background: var(--surface-dark); padding: 4rem 2rem; border-radius: 24px; text-align: center; max-width: 450px; width: 90%; border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .score-big { font-size: 5rem; font-weight: 800; color: var(--brand-purple); margin: 1rem 0; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-run { background: #30363d; color: white; }
        .btn-submit { background: var(--brand-purple); color: white; }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        .timer { font-family: 'Fira Code', monospace; font-weight: 700; color: var(--danger); background: rgba(218, 54, 51, 0.1); padding: 5px 12px; border-radius: 6px; }
        
        #loading-overlay { position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loading-overlay">Booting ProCoder IDE...</div>

    <!-- Final Result Overlay -->
    <div id="result-view">
        <div class="result-card">
            <i class='bx bxs-award' style="font-size: 5rem; color: var(--warning);"></i>
            <h2 id="result-title">Assignment Complete</h2>
            <div class="score-big" id="final-score-display">0 / 0</div>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Your coding assessment has been graded and saved.</p>
            <button class="btn btn-submit" style="width: 100%; justify-content: center;" onclick="window.location.href='student-dashboard.html'">Back to Dashboard</button>
        </div>
    </div>

    <div class="ide-wrapper">
        <header class="ide-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" style="height: 25px;">
                <span id="assign-name" style="font-weight: 700; font-size: 0.9rem;">Assessment</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="timer" id="timer">00:00</div>
                <button class="btn btn-run" onclick="runCode()"><i class='bx bx-play'></i> Run</button>
                <button class="btn btn-submit" id="submit-btn" onclick="submitCurrentProblem()"><i class='bx bx-cloud-upload'></i> Submit Problem</button>
            </div>
        </header>

        <main class="main-layout">
            <!-- Left: Instructions -->
            <div class="panel problem-info">
                <h2 id="p-title">Select Problem</h2>
                <div id="p-statement">Click a problem on the right to begin.</div>
                <h4 style="margin-top: 2rem; font-size: 0.8rem; color: var(--warning);">SAMPLE TEST CASE</h4>
                <div id="p-example" class="test-case-box">No data.</div>
            </div>

            <!-- Center: Monaco Editor -->
            <div id="editor-container"></div>

            <!-- Right: Problem Nav & Results -->
            <div class="panel right-panel">
                <h3 style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 1rem; letter-spacing: 1px;">PROBLEM SET</h3>
                <div id="problem-list"></div>

                <h3 style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2rem; margin-bottom: 1rem; letter-spacing: 1px;">GRADES / RESULTS</h3>
                <div id="results-log">
                    <p style="color: #555; font-style: italic; font-size: 0.8rem;">Click 'Run' to check logic.</p>
                </div>
                
                <button class="btn btn-run" style="margin-top: auto; border: 1px solid var(--danger); color: var(--danger);" onclick="endAssignment()">Finish & Exit</button>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const assignmentId = new URLSearchParams(window.location.search).get('id');
        let currentUser, assignment, problems = [], activeProblem = null;
        let editor, pyodide, timer;
        let submittedProblemIds = new Set();

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || !assignmentId) { window.location.href = 'student-dashboard.html'; return; }
            currentUser = session.user;

            // 1. Fetch Existing Submissions (Check if already done)
            const { data: existing } = await supabaseClient
                .from('code_submissions')
                .select('problem_id, score')
                .eq('user_id', currentUser.id)
                .eq('assignment_id', assignmentId);

            // 2. Fetch Data
            const [assignRes, probRes] = await Promise.all([
                supabaseClient.from('code_assignments').select('*').eq('id', assignmentId).single(),
                supabaseClient.from('code_problems').select('*').eq('assignment_id', assignmentId).order('id', {ascending: true})
            ]);

            assignment = assignRes.data;
            problems = probRes.data;

            // 3. If user has already submitted ALL problems, show final score card immediately
            if (existing && existing.length >= problems.length && problems.length > 0) {
                const totalEarned = existing.reduce((acc, curr) => acc + curr.score, 0);
                const totalPossible = problems.reduce((acc, curr) => acc + curr.points, 0);
                showFinalResults(totalEarned, totalPossible);
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }

            // Mark which problems are already done
            existing?.forEach(s => submittedProblemIds.add(s.problem_id));

            await initIDE();
            renderProblemList();
            
            // Switch to first un-submitted problem
            const nextProb = problems.find(p => !submittedProblemIds.has(p.id)) || problems[0];
            switchProblem(nextProb.id);
            
            startCountdown(assignment.duration);
            document.getElementById('assign-name').innerText = assignment.name;
            document.getElementById('loading-overlay').style.display = 'none';
        }

        async function initIDE() {
            // Load Monaco
            await new Promise(res => {
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
                require(['vs/editor/editor.main'], () => {
                    editor = monaco.editor.create(document.getElementById('editor-container'), {
                        theme: 'vs-dark',
                        fontSize: 16,
                        fontFamily: 'Fira Code',
                        automaticLayout: true,
                        minimap: { enabled: false }
                    });
                    res();
                });
            });
            // Load Python if needed
            if (problems.some(p => p.language === 'python')) pyodide = await loadPyodide();
        }

        function renderProblemList() {
            const list = document.getElementById('problem-list');
            list.innerHTML = problems.map((p, i) => `
                <div class="nav-item ${p.id === activeProblem?.id ? 'active' : ''} ${submittedProblemIds.has(p.id) ? 'submitted' : ''}" 
                     onclick="switchProblem('${p.id}')">
                    <span>${i + 1}. ${p.title}</span>
                    ${submittedProblemIds.has(p.id) ? "<i class='bx bxs-check-circle'></i>" : ""}
                </div>
            `).join('');
        }

        function switchProblem(id) {
            activeProblem = problems.find(p => p.id === id);
            document.getElementById('p-title').innerText = activeProblem.title;
            document.getElementById('p-statement').innerHTML = activeProblem.statement;
            
            const ex = activeProblem.test_cases?.[0];
            document.getElementById('p-example').innerText = ex ? `Input: ${ex.input}\nOutput: ${ex.output}` : "None";

            const lang = activeProblem.language === 'python' ? 'python' : 'javascript';
            monaco.editor.setModelLanguage(editor.getModel(), lang);
            editor.setValue(activeProblem.starter_code);
            
            const subBtn = document.getElementById('submit-btn');
            subBtn.disabled = submittedProblemIds.has(id);
            subBtn.innerHTML = subBtn.disabled ? "Already Submitted" : "<i class='bx bx-cloud-upload'></i> Submit Problem";

            renderProblemList();
        }

        async function runCode() {
            const results = await executeTests(activeProblem.test_cases.slice(0, 1)); // Run only sample
            const r = results[0];
            document.getElementById('results-log').innerHTML = `
                <div style="padding: 10px; border-radius: 8px; background: ${r.passed ? 'rgba(35,134,54,0.1)' : 'rgba(218,54,51,0.1)'}">
                    <p><strong>Sample Test:</strong> ${r.passed ? 'PASSED' : 'FAILED'}</p>
                    <small>Input: ${r.input} <br> Expected: ${r.expected} <br> Got: ${r.actual}</small>
                </div>
            `;
        }

        async function submitCurrentProblem() {
            if(!confirm("Submit logic? This problem will be locked after submission.")) return;
            
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').innerText = "Running Secure Grading...";

            const code = editor.getValue();
            const results = await executeTests(activeProblem.test_cases);
            const passed = results.filter(r => r.passed).length;
            
            // LOGIC: If no tests passed, score is 0.
            const earned = passed > 0 ? Math.round((passed / results.length) * activeProblem.points) : 0;

            const { error } = await supabaseClient
                .from('code_submissions')
                .insert([{
                    user_id: currentUser.id,
                    assignment_id: assignmentId,
                    problem_id: activeProblem.id,
                    score: earned, // Saves 0 if none passed
                    code_body: code,
                    passed_cases: passed,
                    total_cases: results.length
                }]);

            document.getElementById('loading-overlay').style.display = 'none';

            if (!error) {
                submittedProblemIds.add(activeProblem.id);
                alert(`Problem Submitted! Score: ${earned} / ${activeProblem.points}`);
                
                // Auto-switch to next
                const next = problems.find(p => !submittedProblemIds.has(p.id));
                if (next) switchProblem(next.id);
                else endAssignment();
            }
        }

        async function executeTests(cases) {
            const code = editor.getValue();
            const results = [];
            for (let tc of cases) {
                let passed = false, actual = "";
                try {
                    if (activeProblem.language === 'python') {
                        await pyodide.runPythonAsync(`input_val = ${tc.input}\n${code}\nresult = ${activeProblem.function_name}(input_val)`);
                        actual = pyodide.globals.get('result').toString();
                        passed = actual == tc.output.toString();
                    } else {
                        const fn = new Function('input', code + `\n return ${activeProblem.function_name}(input);`);
                        actual = fn(JSON.parse(tc.input));
                        passed = JSON.stringify(actual) == JSON.stringify(JSON.parse(tc.output));
                    }
                } catch (e) { actual = e.message; }
                results.push({ input: tc.input, expected: tc.output, actual, passed });
            }
            return results;
        }

        function startCountdown(sec) {
            let left = sec;
            timer = setInterval(() => {
                const m = Math.floor(left / 60).toString().padStart(2, '0');
                const s = (left % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                if (left <= 0) { clearInterval(timer); endAssignment(); }
                left--;
            }, 1000);
        }

        async function endAssignment() {
            clearInterval(timer);
            // Fetch all submissions for final tally
            const { data } = await supabaseClient
                .from('code_submissions')
                .select('score')
                .eq('user_id', currentUser.id)
                .eq('assignment_id', assignmentId);

            const earned = data?.reduce((a, b) => a + b.score, 0) || 0;
            const possible = problems.reduce((a, b) => a + b.points, 0);
            
            showFinalResults(earned, possible);
        }

        function showFinalResults(score, total) {
            document.getElementById('final-score-display').innerText = `${score} / ${total}`;
            document.getElementById('result-view').style.display = 'flex';
        }

        init();
    </script>
</body>
</html>
