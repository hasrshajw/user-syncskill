<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProCoder IDE - Assessment</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --bg-dark: #0d1117; --surface-dark: #161b22; --border-color: #30363d;
            --text-primary: #c9d1d9; --text-secondary: #8b949e; --brand-purple: #6D28D9;
            --success: #238636; --danger: #da3633;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: var(--bg-dark); color: var(--text-primary); height: 100vh; overflow: hidden; }

        /* Layout */
        .ide-container { display: flex; height: 100vh; flex-direction: column; }
        .ide-header { height: 60px; background: var(--surface-dark); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr 350px; flex: 1; overflow: hidden; }

        /* Sidebar Panels */
        .panel { background: var(--surface-dark); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; padding: 1.5rem; }
        .problem-statement h2 { font-size: 1.25rem; margin-bottom: 1rem; color: #fff; }
        .problem-statement p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem; }
        
        .test-case-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; font-family: 'Fira Code', monospace; font-size: 0.8rem; }

        /* Editor */
        #editor-target { flex: 1; background: #000; }

        /* Right Sidebar: Results & Navigation */
        .right-panel { border-left: 1px solid var(--border-color); border-right: none; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-run { background: #30363d; color: white; }
        .btn-submit { background: var(--brand-purple); color: white; }
        
        .status-pill { padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .status-pass { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .status-fail { background: rgba(218, 54, 51, 0.2); color: #f85149; }

        .timer-box { font-family: 'Fira Code', monospace; color: var(--danger); background: rgba(218, 54, 51, 0.1); padding: 5px 12px; border-radius: 6px; font-weight: 700; }

        /* Proctoring Overlay */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; }
        
        #loading-overlay { position: fixed; inset: 0; background: var(--bg-dark); z-index: 10000; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loading-overlay">Initializing IDE Environment...</div>

    <!-- Proctoring: Fullscreen Requirement -->
    <div id="proctor-overlay" class="overlay" style="display: none;">
        <i class='bx bx-fullscreen' style="font-size: 4rem; color: var(--brand-purple);"></i>
        <h2 style="margin: 1rem 0;">Fullscreen Required</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">To prevent cheating, this exam must be taken in Fullscreen Mode.</p>
        <button class="btn btn-submit" onclick="enterFullscreen()">Enter Fullscreen & Resume</button>
    </div>

    <div class="ide-container">
        <header class="ide-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="Logo" style="height: 24px;">
                <span id="assignment-name" style="font-weight: 700;">Code Assessment</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="timer-box" id="timer">00:00</div>
                <button class="btn btn-run" onclick="runCode()"><i class='bx bx-play'></i> Run Code</button>
                <button class="btn btn-submit" onclick="submitProblem()"><i class='bx bx-cloud-upload'></i> Submit Problem</button>
            </div>
        </header>

        <main class="main-layout">
            <!-- Left: Problem Description -->
            <div class="panel problem-statement">
                <h2 id="p-title">Select a Problem</h2>
                <div id="p-statement"></div>
                <h3 style="margin-top: 2rem; font-size: 0.9rem;">Example Test Case:</h3>
                <div id="p-example" class="test-case-box"></div>
                
                <div style="margin-top: auto; padding-top: 2rem;">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="endExam()">Finish Exam</button>
                </div>
            </div>

            <!-- Center: Code Editor -->
            <div id="editor-target"></div>

            <!-- Right: Results & Selector -->
            <div class="panel right-panel">
                <h3 style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 1rem;">Problems</h3>
                <div id="problem-nav-list" style="display: grid; gap: 8px; margin-bottom: 2rem;"></div>

                <h3 style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 1rem;">Test Results</h3>
                <div id="results-log">
                    <p style="color: #666; font-style: italic;">Run code to see results...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Monaco Editor & Pyodide -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = "https://knfypqztuiemawullipi.supabase.co";
        const SUPABASE_KEY = "sb_publishable_yZhWBF9pFHHxn7jO-zr2Kw_-E-SSktb";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const params = new URLSearchParams(window.location.search);
        const assignmentId = params.get('id');

        let currentUser, assignmentData, problems = [], activeProblem = null;
        let editor, pyodide, timerInterval;
        let violationCount = 0;

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || !assignmentId) { window.location.href = 'student-dashboard.html'; return; }
            currentUser = session.user;

            // Load Data
            const [assignRes, probRes] = await Promise.all([
                supabaseClient.from('code_assignments').select('*').eq('id', assignmentId).single(),
                supabaseClient.from('code_problems').select('*').eq('assignment_id', assignmentId).order('id', {ascending: true})
            ]);

            assignmentData = assignRes.data;
            problems = probRes.data;

            if (!assignmentData || problems.length === 0) { alert("Assignment Error"); return; }

            document.getElementById('assignment-name').innerText = assignmentData.name;
            
            await initEditor();
            if (problems.some(p => p.language === 'python')) {
                pyodide = await loadPyodide();
            }

            renderProblemList();
            switchProblem(problems[0].id);
            startTimer(assignmentData.duration);
            setupProctoring();

            document.getElementById('loading-overlay').style.display = 'none';
        }

        function initEditor() {
            return new Promise(resolve => {
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
                require(['vs/editor/editor.main'], function() {
                    editor = monaco.editor.create(document.getElementById('editor-target'), {
                        value: "",
                        language: 'javascript',
                        theme: 'vs-dark',
                        fontSize: 16,
                        fontFamily: 'Fira Code',
                        automaticLayout: true,
                        minimap: { enabled: false }
                    });
                    resolve();
                });
            });
        }

        function renderProblemList() {
            const nav = document.getElementById('problem-nav-list');
            nav.innerHTML = problems.map((p, idx) => `
                <div class="btn btn-run" style="justify-content: flex-start;" onclick="switchProblem('${p.id}')">
                    <span style="opacity: 0.5;">${idx + 1}.</span> ${p.title}
                </div>
            `).join('');
        }

        function switchProblem(id) {
            activeProblem = problems.find(p => p.id === id);
            document.getElementById('p-title').innerText = activeProblem.title;
            document.getElementById('p-statement').innerHTML = activeProblem.statement;
            
            const example = activeProblem.test_cases?.[0];
            document.getElementById('p-example').innerText = example ? `Input: ${example.input}\nOutput: ${example.output}` : "No examples.";

            // Update Editor Language
            const langMap = { 'python': 'python', 'javascript': 'javascript', 'java': 'java', 'c': 'c', 'html': 'html' };
            monaco.editor.setModelLanguage(editor.getModel(), langMap[activeProblem.language] || 'javascript');
            editor.setValue(activeProblem.starter_code);
        }

        async function runCode() {
            const code = editor.getValue();
            const resultsTarget = document.getElementById('results-log');
            resultsTarget.innerHTML = "Running local test cases...";

            // Use only the first 2 test cases for "Run" (Public tests)
            const publicTests = activeProblem.test_cases.slice(0, 2);
            const results = await executeCode(code, publicTests);
            
            renderResults(results);
        }

        async function executeCode(code, testCases) {
            let results = [];
            for (let tc of testCases) {
                let passed = false;
                let actual = "";
                try {
                    if (activeProblem.language === 'javascript') {
                        const fn = new Function('input', code + `\n return ${activeProblem.function_name}(input);`);
                        actual = fn(JSON.parse(tc.input));
                        passed = JSON.stringify(actual) == JSON.stringify(JSON.parse(tc.output));
                    } 
                    else if (activeProblem.language === 'python') {
                        await pyodide.runPythonAsync(`input_val = ${tc.input}\n${code}\nresult = ${activeProblem.function_name}(input_val)`);
                        actual = pyodide.globals.get('result');
                        passed = actual.toString() == tc.output.toString();
                    }
                    results.push({ input: tc.input, expected: tc.output, actual, passed });
                } catch (e) {
                    results.push({ input: tc.input, expected: tc.output, actual: e.message, passed: false });
                }
            }
            return results;
        }

        function renderResults(results) {
            const target = document.getElementById('results-log');
            target.innerHTML = results.map((r, i) => `
                <div style="margin-bottom: 10px; font-size: 0.85rem;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>Test #${i+1}</strong>
                        <span class="status-pill ${r.passed ? 'status-pass' : 'status-fail'}">${r.passed ? 'Passed' : 'Failed'}</span>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">Expected: ${r.expected} | Got: ${r.actual}</div>
                </div>
            `).join('');
        }

        async function submitProblem() {
            if(!confirm("Submit this problem? You can only submit once per problem.")) return;
            
            const code = editor.getValue();
            const results = await executeCode(code, activeProblem.test_cases); // Run ALL tests
            const passedCount = results.filter(r => r.passed).length;
            const finalScore = Math.round((passedCount / results.length) * activeProblem.points);

            const { error } = await supabaseClient
                .from('code_submissions')
                .insert([{
                    user_id: currentUser.id,
                    assignment_id: assignmentId,
                    problem_id: activeProblem.id,
                    score: finalScore,
                    code_body: code,
                    passed_cases: passedCount,
                    total_cases: results.length
                }]);

            if (!error) {
                alert(`Submitted! You earned ${finalScore} points.`);
            } else {
                alert("Submission failed: " + error.message);
            }
        }

        function startTimer(seconds) {
            let time = seconds;
            timerInterval = setInterval(() => {
                const m = Math.floor(time / 60).toString().padStart(2, '0');
                const s = (time % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                if (time <= 0) { clearInterval(timerInterval); endExam(); }
                time--;
            }, 1000);
        }

        function setupProctoring() {
            // 1. Tab Switching Detection
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    violationCount++;
                    alert(`Proctoring Warning (${violationCount}): Tab switching is not allowed!`);
                }
            });

            // 2. Fullscreen Enforcement
            window.addEventListener('resize', () => {
                if (!window.screenTop && !window.screenY) {
                    document.getElementById('proctor-overlay').style.display = 'flex';
                }
            });
        }

        function enterFullscreen() {
            document.documentElement.requestFullscreen();
            document.getElementById('proctor-overlay').style.display = 'none';
        }

        async function endExam() {
            clearInterval(timerInterval);
            alert("Exam complete. Returning to dashboard.");
            window.location.href = 'student-dashboard.html';
        }

        init();
    </script>
</body>
</html>
